<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.85.0"><link rel=canonical type=text/html href=/en/docs/software/firmware/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Firmware | OpenBikeSensor</title><meta property="og:title" content="Firmware"><meta property="og:description" content="Passing distance measurement for cyclists. Open source, open data, open science."><meta property="og:type" content="website"><meta property="og:url" content="/en/docs/software/firmware/"><meta property="og:site_name" content="OpenBikeSensor"><meta itemprop=name content="Firmware"><meta itemprop=description content="Passing distance measurement for cyclists. Open source, open data, open science."><meta name=twitter:card content="summary"><meta name=twitter:title content="Firmware"><meta name=twitter:description content="Passing distance measurement for cyclists. Open source, open data, open science."><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-00000000-0','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.44c2c163ed1657fea14e97781d97e48e8168dc59f7eefd0768c537631333d9c2.css as=style><link href=/scss/main.min.44c2c163ed1657fea14e97781d97e48e8168dc59f7eefd0768c537631333d9c2.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=/js/slider/ideal-image-slider.min.js></script><script src=/js/slider/iis-bullet-nav.js></script><script src=/js/slider/iis-captions.js></script><script src=/js/obs.js></script><link rel=stylesheet href=/css/slider/ideal-image-slider.css><link rel=stylesheet href=/css/slider/themes/default.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/svg+xml sizes=any href=/favicon.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileImage content="/mstile-144x144.png"><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/en/><span class=navbar-logo><svg id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 42.52 42.52"><polygon points="6.48 10.17 14.66 10.17 14.66 8.17 6.48 8.17 6.48 5.76 4.48 5.76 4.48 12.59 6.48 12.59 6.48 10.17" fill="#fff"/><path d="M18.8 14.62c1.5.0 2.61-1.4 2.61-4.42V8.62c0-3.06-1.11-4.42-2.61-4.42s-2.62 1.36-2.62 4.42V10.2c0 3.02 1.11 4.42 2.62 4.42zm-1-6c0-1.66.35-2.4 1-2.4s1 .74 1 2.4V10.2c0 1.66-.35 2.39-1 2.39s-1-.73-1-2.39z" fill="#fff"/><path d="M24 11.05h.9c1.54.0 2.5-1.17 2.5-3.42s-1-3.29-2.5-3.29h-2.5V14.47H24zm0-4.68h.61c.84.0 1.2.44 1.2 1.26.0 1-.36 1.4-1.2 1.4H24z" fill="#fff"/><polygon points="32.27 12.45 29.68 12.45 29.68 10.24 31.98 10.24 31.98 8.22 29.68 8.22 29.68 6.37 32.27 6.37 32.27 4.34 28.09 4.34 28.09 14.47 32.27 14.47 32.27 12.45" fill="#fff"/><polygon points="36.81 10.03 34.36 4.34 33.09 4.34 33.09 14.47 34.59 14.47 34.59 8.87 37.02 14.47 38.31 14.47 38.31 4.34 36.81 4.34 36.81 10.03" fill="#fff"/><polygon points="36.29 20.07 24.81 20.07 24.81 22.09 36.29 22.09 36.29 24.49 38.31 24.49 38.31 17.66 36.29 17.66 36.29 20.07" fill="#fff"/><path d="M8.52 21a2.72 2.72.0 00.76-2.11c0-1.85-.91-2.69-2.47-2.69H4.49V26.32H7c1.76.0 2.47-1.29 2.47-2.91A2.76 2.76.0 008.52 21zM6.09 18.2h.52c.88.0 1.08.36 1.08 1s-.29.89-.93.89H6.09zm.76 6.1H6.09V22.08h.64c.81.0 1.17.28 1.17 1.1S7.56 24.3 6.85 24.3z" fill="#fff"/><rect x="10.46" y="16.19" width="1.59" height="10.13" fill="#fff"/><polygon points="16.9 26.32 18.8 26.32 16.49 20.29 18.45 16.19 16.6 16.19 14.89 19.95 14.89 16.19 13.3 16.19 13.3 26.32 14.89 26.32 14.89 23.64 15.47 22.43 16.9 26.32" fill="#fff"/><polygon points="23.7 18.22 23.7 16.19 19.52 16.19 19.52 26.32 23.7 26.32 23.7 24.3 21.11 24.3 21.11 22.09 23.41 22.09 23.41 20.07 21.11 20.07 21.11 18.22 23.7 18.22" fill="#fff"/><path d="M7.18 32.11C6.35 31.74 6 31.4 6 30.8s.23-.88.76-.88.92.25 1.18.92l1.18-1.29a2.48 2.48.0 00-2.38-1.66c-1.61.0-2.33 1.25-2.33 2.93A3.15 3.15.0 006.33 34c1 .49 1.25.78 1.25 1.37a.79.79.0 01-.86.88 1.4 1.4.0 01-1.32-.91L4.21 36.66a2.7 2.7.0 002.65 1.66c1.5.0 2.31-1.19 2.31-3A2.94 2.94.0 007.18 32.11z" fill="#fff"/><polygon points="10.04 38.17 14.22 38.17 14.22 36.14 11.63 36.14 11.63 33.94 13.93 33.94 13.93 31.92 11.63 31.92 11.63 30.07 14.22 30.07 14.22 28.04 10.04 28.04 10.04 38.17" fill="#fff"/><polygon points="18.76 33.72 16.3 28.04 15.04 28.04 15.04 38.17 16.54 38.17 16.54 32.56 18.97 38.17 20.26 38.17 20.26 28.04 18.76 28.04 18.76 33.72" fill="#fff"/><path d="M24.1 32.11c-.84-.37-1.18-.71-1.18-1.31s.23-.88.76-.88.92.25 1.18.92L26 29.55a2.49 2.49.0 00-2.38-1.66c-1.62.0-2.34 1.25-2.34 2.93A3.15 3.15.0 0023.24 34c1 .49 1.25.78 1.25 1.37a.79.79.0 01-.85.88 1.41 1.41.0 01-1.33-.91l-1.19 1.28a2.71 2.71.0 002.65 1.66c1.51.0 2.32-1.19 2.32-3A2.94 2.94.0 0024.1 32.11z" fill="#fff"/><path d="M29.42 27.89c-1.51.0-2.61 1.37-2.61 4.42V33.9c0 3 1.1 4.42 2.61 4.42S32 36.92 32 33.9V32.31c0-3.05-1.08-4.42-2.58-4.42zm1 6c0 1.66-.35 2.39-1 2.39s-1-.73-1-2.39V32.31c0-1.66.35-2.39 1-2.39s1 .73 1 2.39z" fill="#fff"/><path d="M38 31.23c0-2.12-1-3.19-2.51-3.19H33V38.17h1.59V34.34h.82l1.11 3.83h1.75L37 33.91a3.08 3.08.0 001-2.68zm-2.7 1.08h-.71V30.07h.71c.64.0 1.1.19 1.1 1.16S36 32.31 35.34 32.31z" fill="#fff"/></svg></span><span class="text-uppercase font-weight-bold">OpenBikeSensor</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/en/><span class=active>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/en/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/community/><span>Community</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/software/firmware/>Deutsch</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en/docs/software/firmware/>Return to the regular view of this page</a>.</p></div><h1 class=title>Firmware</h1><ul><li>1: <a href=#pg-41c2f35e54b5a010a9bc10abb186416b>Architecture</a></li><li>2: <a href=#pg-4475898143bfbfc7c8d256718209faab>Setup of Development Environment</a></li><li>3: <a href=#pg-42d00c5658342027b293234aa25801d1>Coding Guidelines</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-41c2f35e54b5a010a9bc10abb186416b>1 - Architecture</h1><h1 id=architecture>Architecture</h1><blockquote><p>TODO: Introduction</p></blockquote><p>Board:</p><ul><li><a href=https://github.com/espressif/arduino-esp32>ESP32 by Espressif</a></li></ul><p>Libraries:</p><ul><li><a href=https://github.com/bblanchon/ArduinoJson>ArduinoJson by Benoit Blanchon</a></li><li><a href=https://github.com/rlogiacco/CircularBuffer>CircularBuffer by AgileWare</a></li><li><a href=https://github.com/mikalhart/TinyGPSPlus>TinyGPSPlus by Mikal Hart</a></li><li><a href=https://github.com/ThingPulse/esp8266-oled-ssd1306>SSD1306 by ThingPulse</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4475898143bfbfc7c8d256718209faab>2 - Setup of Development Environment</h1><p>Our firmware uses the great <a href=https://platformio.org/>PlatformIO</a> for easy
management of the toolchains and dependencies required when developing an
application for an embedded device. Thanks to this, you are rather free in the
choice of the development environment. Here are some options.</p><div class="alert alert-info" role=alert>We do not support <em>Arduino IDE</em> anymore since we&rsquo;ve switched to PlatformIO.</div><h2 id=vscode>VSCode</h2><p>The easiest way to get started is through the
<a href=https://code.visualstudio.com/>VSCode</a> IDE/Editor by Microsoft. We support it
for the foreseeable future.</p><ol><li>Download and install <a href=https://code.visualstudio.com/>Visual Studio Code</a>.</li><li>Open the <code>open-bike-sensor.code-workspace</code> in the project root.</li><li>Install the recommended extensions (this might take a while, because <a href>Platform.io</a> gets installed) and restart VSCode when required.</li><li>Linux only: Install <code>platformio-udev.rules</code> by <a href=https://docs.platformio.org/en/latest/faq.html#platformio-udev-rules>following this guide</a>.</li><li>Compile the code (Sidebar: <code>👽 > Build</code>; Bottom bar: <code>✅</code>)</li><li>Connect your ESP and upload the code (Sidebar: <code>👽 > Upload</code>; Bottom bar: ➡️)</li></ol><p>Alternatively you can also download the dependencies yourself and install it with the Arduino IDE (see below).</p><h3 id=troubleshooting>Troubleshooting</h3><ul><li><p><strong>Can&rsquo;t upload to device</strong>
You can specify the device port that VS Code should upload to. Duplicate the <code>custom_config.ini.example</code> file to <code>custom_config.ini</code> and set the <code>upload_port</code> there manually. If this option is not set, the upload port will be autodetected which can fail on some systems or might select the wrong device if other devices are plugged in.</p></li><li><p><strong>Compiling the code fails</strong>
Use the <code>Clean</code> command and delete the <code>.pio</code> directory. Compiling the code again should work now. If any errors persist, please create a new issue!</p></li></ul><h2 id=command-line>Command line</h2><ol><li>Install <code>platformio</code> command line tool for your operating system.</li><li>Clone the repository.</li><li>Copy <code>custom_config.ini.example</code> to <code>custom_config.ini</code> and modify it to
contain your upload port (only required if autodetection fails, or you want
to flash via OTA).</li><li>Connect the sensor via USB, or put it into server mode for OTA flashing.</li><li>Run <code>platformio run -t upload</code>. This will compile and upload your firmware.</li></ol><h2 id=clion>CLion</h2><p>Information on this proprietary IDE can be found
<a href=https://www.jetbrains.com/de-de/clion/>here</a>. While it works for now, it is
not officially supported by the OBS team.</p><ol><li>Install <a href=https://docs.platformio.org/en/latest/core/installation.html#installation-methods>PlatformIO Core (CLI)</a>.</li><li>Download and open <a href=https://www.jetbrains.com/de-de/clion/>CLion</a>.</li><li>Install the <a href=https://plugins.jetbrains.com/plugin/13922-platformio-for-clion>PlatformIO for CLion plugin</a>. Open <code>Configure > Plugins</code> in the welcome screen (alternatively <code>Plugins</code> in the preferences) and search for &ldquo;PlatformIO&rdquo; in the <code>Marketplace</code> tab.</li><li>Restart CLion.</li><li>Open the project folder with<code>Open or Import</code> in the welcome screen (alternatively <code>File > Open ...</code> using the menu bar)</li><li>A popup &ldquo;Create CMakeLists.txt?&rdquo; will appear. Select &ldquo;yes&rdquo;.</li><li>Open the CLion preferences and navigate to <code>Build, Execution, Deployment > CMake</code>. Delete the <code>Debug</code> profile and add a new profile. This new profile should automatically have the name <code>esp32dev</code>. Apply these changes and close the preferences.</li><li>Select the configuration <code>PlatformIO Build & Upload | esp32dev</code> in the top bar.</li><li>Use the <code>🔨 Build</code> button to compile the code.</li><li>Connect your ESP and use the <code>▶ Run</code> button to compile and upload the code. To upload without re-compiling the code, switch to the configuration <code>PlatformIO Only Upload | esp32dev</code> in the top bar.</li></ol><h3 id=troubleshooting-1>Troubleshooting</h3><ul><li><p><strong>Can&rsquo;t upload to device</strong>
You can specify the device port that CLion should upload to. Duplicate the <code>custom_config.ini.example</code> file to <code>custom_config.ini</code> and set the <code>upload_port</code> there manually. If this option is not set, the upload port will be autodetected which can fail on some systems or might select the wrong device if other devices are plugged in.</p></li><li><p><strong>Compiling the code fails</strong>
In the menu bar run/click <code>Tools > PlatformIO > Re-Init</code> and then try to compile the code again. If this didn&rsquo;t fix it delete the directories <code>.pio</code> and <code>cmake-build-*</code>. Compiling the code again should work now. If any errors persist, please create a new issue!</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-42d00c5658342027b293234aa25801d1>3 - Coding Guidelines</h1><h2 id=platformioini>platformio.ini</h2><p>The <code>platformio.ini</code> is the main project configuration file.
It configures <a href=https://docs.platformio.org/en/latest/projectconf/section_platformio.html#id4>PlatformIO</a> to build and flash the ESP32</p><h2 id=custom_configini>custom_config.ini</h2><p>PlatformIO supports the option <a href=https://docs.platformio.org/en/latest/projectconf/section_platformio.html>extra_configs</a>,
which allows to include additional configurations. Our <code>platformio.ini</code> is preconfigured a custion configuraion inthe file <code>custom_config.ini</code>.
An example custion configuration file can be found in the root folder of the firmware.</p><h3 id=developer-mode>Developer mode</h3><p>To enable the developer mode, uncomment the following line in the <code>custom_config.ini</code> and flash the firmware:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>build_flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>-D DEVELOP</span>
</code></pre></div><p>The developer mode enables additional dvelopment options menu in the configuration web interface, where it&rsquo;s possible to configure:</p><ul><li>whether the grid on the display is shown (useful for text debugging)</li><li>whether the WLAN password should be printed to the serial interface (useful for WLAN debugging)</li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 OpenBikeSensor contributors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js integrity=sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s crossorigin=anonymous></script><script src=/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js integrity="sha256-XHS4cMaVOTGnBfOQpJx+TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin=anonymous></script></body></html>